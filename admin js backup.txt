window.addEventListener('DOMContentLoaded', () => {
  const btnCargar = document.getElementById('btnCargar');
  const selectSala = document.getElementById('sala');
  const desde = document.getElementById('desde');
  const hasta = document.getElementById('hasta');
  const estadisticasDiv = document.getElementById('estadisticas');

  let charts = [];

  btnCargar.addEventListener('click', async () => {
    const sala = selectSala.value;
    const from = desde.value;
    const to = hasta.value;

    estadisticasDiv.innerHTML = 'Cargando estadísticas...';

    try {
      const res = await fetch(`/api/stats?sala=${encodeURIComponent(sala)}&from=${from}&to=${to}`);
      if (!res.ok) throw new Error('Error al cargar estadísticas');
      const data = await res.json();

      charts.forEach(c => c.destroy());
      charts = [];
      estadisticasDiv.innerHTML = '';

      function crearSeccion(titulo) {
        const seccion = document.createElement('div');
        seccion.className = 'grafico-seccion';
        const h2 = document.createElement('h2');
        h2.textContent = titulo;
        seccion.appendChild(h2);
        const cont = document.createElement('div');
        cont.className = 'graficos-container';
        seccion.appendChild(cont);
        estadisticasDiv.appendChild(seccion);
        return cont;
      }

      function crearGrafico(tipo, etiquetas, valores, contenedor, label) {
        const canvasDiv = document.createElement('div');
        canvasDiv.className = 'grafico-container';
        const canvas = document.createElement('canvas');
        canvasDiv.appendChild(canvas);
        contenedor.appendChild(canvasDiv);

        const chart = new Chart(canvas, {
          type: tipo,
          data: {
            labels: etiquetas,
            datasets: [{
              label: label,
              data: valores,
              backgroundColor: [
                '#0c2340','#193763','#1a4a8f','#2c5ca5','#3d70c1','#5a88d1','#7aa0e2','#a2b8f0'
              ],
              borderColor: '#0c2340',
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'top' },
              tooltip: { mode: 'index', intersect: false }
            },
            scales: tipo==='line' ? {
              y: { beginAtZero: true },
              x: { title: { display:true, text:'Tiempo' } }
            } : {}
          }
        });

        charts.push(chart);
      }

      // ✅ Registros por sala
      const contSala = crearSeccion('Registros por Sala');
      const labelsSala = Object.keys(data.por_sala);
      const valoresSala = Object.values(data.por_sala);
      crearGrafico('bar', labelsSala, valoresSala, contSala, 'Usuarios');

      // ✅ Registros por actividad
      const contAct = crearSeccion('Registros por Actividad');
      const labelsAct = Object.keys(data.por_actividad);
      const valoresAct = Object.values(data.por_actividad);
      crearGrafico('pie', labelsAct, valoresAct, contAct, 'Cantidad');

      // ✅ Porcentaje de actividades (doughnut)
      const contActPerc = crearSeccion('Porcentaje de Actividades');
      crearGrafico('doughnut', labelsAct, valoresAct, contActPerc, '% Actividades');

      // ✅ Registros por día
      const contDia = crearSeccion('Registros por Día');
      const labelsDia = Object.keys(data.por_dia);
      const valoresDia = Object.values(data.por_dia);
      crearGrafico('line', labelsDia, valoresDia, contDia, 'Registros');

      // ✅ Registros por hora
      const contHora = crearSeccion('Registros por Hora');
      const labelsHora = Object.keys(data.por_hora);
      const valoresHora = Object.values(data.por_hora);
      crearGrafico('line', labelsHora, valoresHora, contHora, 'Registros');

    } catch (err) {
      estadisticasDiv.innerHTML = 'Error cargando estadísticas';
      console.error(err);
    }
  });

  // Carga inicial
  btnCargar.click();
});
